# Alembic

## Initial Setup

How to initialize alembic, _i.e._ when you start from scratch.
_E.g._ in throw away postgres db:

```
sudo docker run \
    --rm \
    -e "POSTGRES_HOST_AUTH_METHOD=trust" \
    -e "POSTGRES_DB=main" \
    -e "POSTGRES_USER=postgres" \
    -p "5432:5432" \
    postgres:12-alpine
```

1. define SQLAlchemy declerative base with some generic models
1. `alembic init alembic`
1. edit `.ini` with connection string
1. edit `env.py` for autogenerate and adding repo directory to path
1. also edit `env.py` to take a DB URI from env
1. start a throwaway postgres db (empty)
1. `alembic revision --autogenerate -m "init"`, checked migration scripts
1. `alembic upgrade head`, checked table creation
1. switch off db

## Update Database Schema

For when you want to make changes to the database schema.
While the database server is running:

1. Edit `models.py`
2. Run `alembic revision --autogenerate -m "<a-message>"` with some meaningful message
3. Check autogenerated migration script
4. Run `alembic upgrade head`
5. Test models and database are in sync `pytest alembic`
